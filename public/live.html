<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live ‚Ä¢ Ring Camera Server</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 16px}
    h1{font-size:22px;margin:0}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#111827;color:#e5e7eb;cursor:pointer}
    .btn:hover{background:#0b1220}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=number]{width:90px;background:#0b132b;color:#e5e7eb;border:1px solid #233052;padding:10px 12px;border-radius:10px;outline:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:12px}
    .card{background:#0b1022;border:1px solid #1e2a4a;border-radius:12px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .thumb{width:100%;height:180px;object-fit:cover;background:#0b132b}
    .card-body{padding:12px}
    .title{font-weight:700;margin:0 0 8px;font-size:15px}
    .muted{color:#93a4c3;font-size:12px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2a3a63;margin-left:8px;font-size:12px;color:#c7d2fe}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üî¥ Live View <span id="statusPill" class="pill">stopped</span></h1>
      <div class="actions">
        <a class="btn" href="/">üè† Dashboard</a>
        <a class="btn" href="/cameras.html">üìπ Cameras</a>
        <a class="btn" href="/images.html">üì∏ Images</a>
      </div>
    </div>
    <div class="row">
      <label for="interval">Refresh (sec)</label>
      <input id="interval" type="number" min="1" value="3" />
      <button class="btn" id="startAll">‚ñ∂Ô∏è Start All</button>
      <button class="btn" id="stopAll">‚è∏Ô∏è Stop All</button>
      <button class="btn" id="refreshList">üîÑ Reload Cameras</button>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const startAllBtn = document.getElementById('startAll');
    const stopAllBtn = document.getElementById('stopAll');
    const refreshListBtn = document.getElementById('refreshList');
    const intervalInput = document.getElementById('interval');
    const statusPill = document.getElementById('statusPill');
    let timers = new Map(); // cameraName -> timer
    let cameras = [];

    function cardTemplate(name){
      const enc = encodeURIComponent(name);
      const id = btoa(name).replace(/=/g,'');
      return `
        <div class="card" id="card-${id}">
          <img id="img-${id}" class="thumb" alt="${name}"/>
          <div class="card-body">
            <div class="title">${name}</div>
            <div class="row" style="margin:8px 0 10px">
              <button class="btn" onclick="start('${enc}','${id}')">‚ñ∂Ô∏è Start</button>
              <button class="btn" onclick="stop('${name}')">‚è∏Ô∏è Stop</button>
              <button class="btn" onclick="snapshot('${enc}','${id}', true)">üì∏ Snapshot</button>
            </div>
            <div class="muted" id="meta-${id}">stopped</div>
          </div>
        </div>`
    }

    async function loadCameras(){
      const res = await fetch('/api/cameras');
      const data = await res.json();
      cameras = data.cameras || [];
      grid.innerHTML = cameras.map(cardTemplate).join('');
    }

    function snapshot(encName, id, mark){
      const img = document.getElementById('img-'+id);
      const meta = document.getElementById('meta-'+id);
      const url = encName ? `/api/snapshot?camera=${encName}&t=${Date.now()}` : `/api/snapshot?t=${Date.now()}`;
      img.src = url;
      if(mark){ meta.textContent = new Date().toLocaleTimeString(); }
    }

    function start(encName, id){
      const name = decodeURIComponent(encName);
      stop(name);
      const tick = ()=> snapshot(encName, id, true);
      tick();
      const ms = Math.max(1, parseInt(intervalInput.value)||3) * 1000;
      const timer = setInterval(tick, ms);
      timers.set(name, timer);
      document.getElementById('meta-'+id).textContent = 'live @ ' + (ms/1000) + 's';
      statusPill.textContent = 'running';
    }

    function stop(name){
      const timer = timers.get(name);
      if(timer){ clearInterval(timer); timers.delete(name); }
      // update pill if none running
      if(timers.size === 0){ statusPill.textContent='stopped'; }
    }

    startAllBtn.onclick = ()=>{
      cameras.forEach(n=> start(encodeURIComponent(n), btoa(n).replace(/=/g,'')) );
    };
    stopAllBtn.onclick = ()=>{ cameras.forEach(stop); };
    refreshListBtn.onclick = loadCameras;

    loadCameras();
  </script>
</body>
</html>


